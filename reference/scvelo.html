<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>RNA velocity with scVelo — scvelo • velociraptor</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="RNA velocity with scVelo — scvelo" />
<meta property="og:description" content="Perform RNA velocity calculations with the scVelo package." />
<meta property="og:image" content="/logo.png" />






<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  

  

  </head>

  <body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">velociraptor</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../articles/velociraptor.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="divider"></li>
    <li>
      <a href="../articles/index.html">More articles...</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/kevinrue/velociraptor/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>RNA velocity with <span class="pkg">scVelo</span></h1>
    <small class="dont-index">Source: <a href='https://github.com/kevinrue/velociraptor/blob/master/R/scvelo.R'><code>R/scvelo.R</code></a></small>
    <div class="hidden name"><code>scvelo.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Perform RNA velocity calculations with the <span class="pkg">scVelo</span> package.</p>
    </div>

    <div class="ref-usage sourceCode"><pre class='sourceCode r'><code><span class='fu'>scvelo</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>...</span><span class='op'>)</span>

<span class='co'># S4 method for ANY</span>
<span class='fu'>scvelo</span><span class='op'>(</span>
  <span class='va'>x</span>,
  subset.row <span class='op'>=</span> <span class='cn'>NULL</span>,
  sf.X <span class='op'>=</span> <span class='cn'>NULL</span>,
  sf.spliced <span class='op'>=</span> <span class='cn'>NULL</span>,
  sf.unspliced <span class='op'>=</span> <span class='cn'>NULL</span>,
  use.theirs <span class='op'>=</span> <span class='cn'>FALSE</span>,
  mode <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"steady_state"</span>, <span class='st'>"deterministic"</span>, <span class='st'>"stochastic"</span>, <span class='st'>"dynamical"</span><span class='op'>)</span>,
  scvelo.params <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='op'>)</span>,
  dimred <span class='op'>=</span> <span class='cn'>NULL</span>,
  ncomponents <span class='op'>=</span> <span class='fl'>30</span>,
  BPPARAM <span class='op'>=</span> <span class='fu'>SerialParam</span><span class='op'>(</span><span class='op'>)</span>,
  BSPARAM <span class='op'>=</span> <span class='fu'>bsparam</span><span class='op'>(</span><span class='op'>)</span>
<span class='op'>)</span>

<span class='co'># S4 method for SummarizedExperiment</span>
<span class='fu'>scvelo</span><span class='op'>(</span>
  <span class='va'>x</span>,
  <span class='va'>...</span>,
  assay.X <span class='op'>=</span> <span class='st'>"counts"</span>,
  assay.spliced <span class='op'>=</span> <span class='st'>"spliced"</span>,
  assay.unspliced <span class='op'>=</span> <span class='st'>"unspliced"</span>
<span class='op'>)</span>

<span class='co'># S4 method for SingleCellExperiment</span>
<span class='fu'>scvelo</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>...</span>, sf.X <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/SingleCellExperiment/man/sizeFactors.html'>sizeFactors</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span>, dimred <span class='op'>=</span> <span class='cn'>NULL</span>, use.dimred <span class='op'>=</span> <span class='cn'>NULL</span><span class='op'>)</span></code></pre></div>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>x</th>
      <td><p>A named list of three matrices of the same dimensions where genes are in rows and cells are in columns.
The list should contain <code>"spliced"</code> and <code>"unspliced"</code> entries containing spliced and unspliced counts, respectively.
It should also contain an <code>"X"</code> entry containing the &#8220;usual&#8221; count matrix, see details below.</p>
<p>Alternatively, a SummarizedExperiment object containing three such matrices among its assays.</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>For the generic, further arguments to pass to specific methods.
For the SummarizedExperiment and SingleCellExperiment methods, further arguments to pass to the ANY method.</p></td>
    </tr>
    <tr>
      <th>subset.row</th>
      <td><p>A character, integer or logical vector specifying the genes to use for the velocity calculations.
Defaults to all genes.</p></td>
    </tr>
    <tr>
      <th>sf.X</th>
      <td><p>A numeric vector containing size factors for usual count matrix.
Defaults to <code><a href='https://rdrr.io/pkg/scuttle/man/librarySizeFactors.html'>librarySizeFactors</a></code> on the <code>"X"</code> matrix in <code>x</code>.</p></td>
    </tr>
    <tr>
      <th>sf.spliced</th>
      <td><p>A numeric vector containing size factors for the spliced counts for each cell.
Defaults to <code><a href='https://rdrr.io/pkg/scuttle/man/librarySizeFactors.html'>librarySizeFactors</a></code> on the <code>"spliced"</code> matrix in <code>x</code>.</p></td>
    </tr>
    <tr>
      <th>sf.unspliced</th>
      <td><p>A numeric vector containing size factors for the unspliced counts for each cell.
Defaults to <code><a href='https://rdrr.io/pkg/scuttle/man/librarySizeFactors.html'>librarySizeFactors</a></code> on the <code>"unspliced"</code> matrix in <code>x</code>.</p></td>
    </tr>
    <tr>
      <th>use.theirs</th>
      <td><p>Logical scalar indicating whether <span class="pkg">scVelo</span>'s gene filtering and normalization should be used.</p></td>
    </tr>
    <tr>
      <th>mode</th>
      <td><p>String specifying the method to use to estimate the transcriptional dynamics.</p></td>
    </tr>
    <tr>
      <th>scvelo.params</th>
      <td><p>List of lists containing arguments for individual <span class="pkg">scVelo</span> functions, see details below.</p></td>
    </tr>
    <tr>
      <th>dimred</th>
      <td><p>A low-dimensional representation of the cells with number of rows equal to the number of cells in <code>x</code>,
used to find the nearest neighbors.</p></td>
    </tr>
    <tr>
      <th>ncomponents</th>
      <td><p>Numeric scalar indicating the number of principal components to obtain.
Only used if <code>use.theirs=FALSE</code> and <code>dimred=NULL</code>.</p></td>
    </tr>
    <tr>
      <th>BPPARAM</th>
      <td><p>A BiocParallelParam object specifying whether the PCA calculations should be parallelized.
Only used if <code>use.theirs=FALSE</code> and <code>dimred=NULL</code>.</p></td>
    </tr>
    <tr>
      <th>BSPARAM</th>
      <td><p>A BiocSingularParam object specifying which algorithm should be used to perform the PCA.
Only used if <code>use.theirs=FALSE</code> and <code>dimred=NULL</code>.</p></td>
    </tr>
    <tr>
      <th>assay.X</th>
      <td><p>An integer scalar or string specifying the assay of <code>x</code> containing the usual count matrix.</p></td>
    </tr>
    <tr>
      <th>assay.spliced</th>
      <td><p>An integer scalar or string specifying the assay of <code>x</code> containing the spliced counts.</p></td>
    </tr>
    <tr>
      <th>assay.unspliced</th>
      <td><p>An integer scalar or string specifying the assay of <code>x</code> containing the unspliced counts.</p></td>
    </tr>
    <tr>
      <th>use.dimred</th>
      <td><p>String naming the entry of <code><a href='https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html'>reducedDims</a>(x)</code> to use for nearest neighbor calculations.
Ignored if <code>dimred</code> is supplied.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A <a href='https://rdrr.io/pkg/SingleCellExperiment/man/SingleCellExperiment.html'>SingleCellExperiment</a> is returned containing the output of the velocity calculations.
Of particular interest are:</p><ul>
<li><p>the <code>velocity_pseudotime</code> field in the <code>colData</code>,
containing the velocity pseudotime for each cell.</p></li>
<li><p>the <code>velocity</code> entry of the <code>assays</code>,
containing the velocity vectors for each cell.</p></li>
</ul><p>The output will always have number of columns equal to the number of cells supplied in <code>x</code>,
though the number of rows will depend on whether any subsetting (if <code>subset.row</code> is supplied) 
or feature selection (if <code>use.theirs=TRUE</code>) was performed.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>This function uses the <span class="pkg">scVelo</span> Python package (<a href='https://pypi.org/project/scvelo/'>https://pypi.org/project/scvelo/</a>) for RNA velocity calculations.
The main difference from the original <span class="pkg">velocyto</span> approach is that the dynamical model of <span class="pkg">scVelo</span>
does not rely on the presence of observed steady-state populations,
which should improve the reliability of the velocity calculations in general applications.</p>
<p>For consistency with other Bioconductor workflows, we perform as many standard steps in R as we can
before starting the velocity calculations with <span class="pkg">scVelo</span>.
This involves:</p><ol>
<li><p>Size factor-based normalization with <code>sf.*</code> values and <code><a href='https://rdrr.io/pkg/scuttle/man/normalizeCounts.html'>normalizeCounts</a></code>.
For <code>"X"</code>, log-transformation is performed as well, while for the others, only scaling normalization is performed.</p></li>
<li><p>Subsetting all matrices to <code>subset.row</code>, most typically to a subset of interest, e.g., highly variable genes.
Note that, if set, any subsetting is done <em>after</em> normalization so that library sizes are correctly computed.</p></li>
<li><p>If <code>dimred=NULL</code>, the PCA step on the log-expression values derived from the <code>"X"</code> matrix,
using the specified <code>BSPARAM</code> to obtain the first <code>ncomponents</code> PCs.</p></li>
</ol><p>This allows us to guarantee that, for example, the log-expression matrix of HVGs or the PCA coordinates
are the same as that used in other applications like clustering or trajectory reconstruction.</p>
<p>Nonetheless, one can set <code>use.theirs=TRUE</code> to directly use the entire <span class="pkg">scVelo</span> normalization and filtering pipeline.
This ignores all of the size factors arguments (<code>sf.*</code>),
all of the PCA-related arguments (<code>ncomponents</code>, <code>BSPARAM</code>) and <code>subset.row</code>.
However, if a low-dimensionality result is supplied via <code>dimred</code> or <code>use.dimred</code>,
the <span class="pkg">scVelo</span> PCA will always be omitted.</p>
<p>Upon first use, this function will instantiate a conda environment containing the <span class="pkg">scVelo</span> package.
This is done via the <span class="pkg">basilisk</span> package - see the documentation for that package for trouble-shooting.</p>
    <h2 class="hasAnchor" id="comments-on-the-three-matrices"><a class="anchor" href="#comments-on-the-three-matrices"></a>Comments on the three matrices</h2>

    

<p>Strictly speaking, only the spliced and unspliced matrices are necessary for the velocity calculations.
However, it is often the case that the spliced matrix is not actually the same as a &#8220;usual&#8221; count matrix
(e.g., generated by summing counts across all exons for all mapped genes).
This is due to differences in the handling of ambiguous reads that map across exon-intron boundaries,
or to genomic regions that can be either exonic or intronic depending on the isoform;
the spliced count matrix is more likely to exclude such reads.</p>
<p>We request the usual count matrix as the <code>"X"</code> entry of <code>x</code> to ensure that
the PCA and nearest neighbor detection in <span class="pkg">scVelo</span> are done on the same data
as that used in other steps of the large analysis (e.g., clustering, visualization, trajectory reconstruction).
In practice, if the usual count matrix is not available, one can often achieve satisfactory results
by simply re-using the spliced count matrix as both the <code>"X"</code> and <code>"spliced"</code> entries of <code>x</code>.</p>
<p>Note that if reduced dimensions are supplied in <code>dimred</code>,
any <code>"X"</code> entry is only used to create the AnnData object and is not used in any actual calculations.</p>
    <h2 class="hasAnchor" id="additional-arguments-to-python"><a class="anchor" href="#additional-arguments-to-python"></a>Additional arguments to Python</h2>

    

<p>Additional arguments to <span class="pkg">scVelo</span> functions are provided via <code>scvelo.params</code>.
This is a named list where each entry is named after a function and is itself a named list of arguments for that function.
The following function names are currently recognized:</p><ul>
<li><p><code>"filter_and_normalize"</code>, for gene selection and normalization.
This is not used unless <code>use.theirs=TRUE</code>.</p></li>
<li><p><code>"moments"</code>, for PCA and nearest neighbor detection.
The PCA is not performed if <code>dimred</code> or <code>use.dimred</code> is already supplied.</p></li>
<li><p><code>"recover_dynamics"</code></p></li>
<li><p><code>"velocity"</code></p></li>
<li><p><code>"velocity_graph"</code></p></li>
<li><p><code>"velocity_pseudotime"</code></p></li>
<li><p><code>"latent_time"</code></p></li>
<li><p><code>"velocity_confidence"</code></p></li>
</ul><p>See the <span class="pkg">scVelo</span> documentation for more details about the available arguments.</p>
    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>Bergen, V., Lange, M., Peidli, S. et al. Generalizing RNA velocity to transient cell states through dynamical modeling. Nat Biotechnol 38, 1408–1414 (2020). <a href='https://doi.org/10.1038/s41587-020-0591-3'>https://doi.org/10.1038/s41587-020-0591-3</a></p>
    <h2 class="hasAnchor" id="author"><a class="anchor" href="#author"></a>Author</h2>

    <p>Aaron Lun, Charlotte Soneson</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <div class="ref-examples sourceCode"><pre class='sourceCode r'><code><span class='r-in'><span class='co'># Using mock data to demonstrate the process:</span></span>
<span class='r-in'><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>scuttle</span><span class='op'>)</span></span>
<span class='r-in'><span class='va'>sce1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scuttle/man/mockSCE.html'>mockSCE</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span class='r-in'><span class='va'>sce2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/scuttle/man/mockSCE.html'>mockSCE</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'><span class='va'>spliced</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/SingleCellExperiment/man/assays.html'>counts</a></span><span class='op'>(</span><span class='va'>sce1</span><span class='op'>)</span></span>
<span class='r-in'><span class='va'>unspliced</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/SingleCellExperiment/man/assays.html'>counts</a></span><span class='op'>(</span><span class='va'>sce2</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'><span class='va'>out</span> <span class='op'>&lt;-</span> <span class='fu'>scvelo</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>X<span class='op'>=</span><span class='va'>spliced</span>, spliced<span class='op'>=</span><span class='va'>spliced</span>, unspliced<span class='op'>=</span><span class='va'>unspliced</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
</code></pre></div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p><p>Developed by Kevin Rue-Albrecht, Aaron Lun, Charlotte Soneson, Michael Stadler.</p></p>
</div>

<div class="pkgdown">
  <p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 1.6.1.9001.</p></p>
</div>

      </footer>
   </div>

  


  

  </body>
</html>


